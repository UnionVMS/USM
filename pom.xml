<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>

	<groupId>eu.europa.ec.mare.oss.usm</groupId>
	<version>2.2.0-SNAPSHOT</version>
	<artifactId>USM</artifactId>
	<packaging>pom</packaging>
	
	<properties>
		<docker.dev.version>3.10.0.alpine-SNAPSHOT</docker.dev.version>
	</properties>

	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>fish.focus.uvms.maven</groupId>
				<artifactId>uvms-pom-gis-deps</artifactId>
				<version>1.10</version>
				<type>pom</type>
			</dependency>
			<dependency>
				<groupId>fish.focus.uvms.maven</groupId>
				<artifactId>uvms-pom-logging-deps</artifactId>
				<version>1.10</version>
				<type>pom</type>
			</dependency>
			<dependency>
				<groupId>fish.focus.uvms.maven</groupId>
				<artifactId>uvms-pom-monitoring-deps</artifactId>
				<version>1.10</version>
				<type>pom</type>
			</dependency>
			<dependency>
				<groupId>fish.focus.uvms.maven</groupId>
				<artifactId>uvms-pom-test-deps</artifactId>
				<version>1.10</version>
				<type>pom</type>
			</dependency>
			<dependency>
				<groupId>fish.focus.uvms.maven</groupId>
				<artifactId>uvms-pom-arquillian-deps</artifactId>
				<version>1.10</version>
				<type>pom</type>
			</dependency>
		</dependencies>
	</dependencyManagement>

	<modules>
		<!-- Uncomment and adapt usm-parent module version in the other modules 
			if testing inherited settings -->
		<!-- <module>usm-parent</module> -->

		<module>database/liquibase</module>
		<module>java</module>
	</modules>

	<distributionManagement>
		<repository>
			<id>focus-releases</id>
			<name>UnionVms Repository</name>
			<url>http://nexus.focus.fish/nexus/content/repositories/releases/</url>
		</repository>
		<snapshotRepository>
			<id>focus-snapshots</id>
			<name>UnionVms Snapshot Repository</name>
			<url>http://nexus.focus.fish/nexus/content/repositories/snapshots/</url>
		</snapshotRepository>
	</distributionManagement>
	<build>
		<pluginManagement>
			<plugins>
				<plugin>
				    <groupId>org.wildfly.plugins</groupId>
				    <artifactId>wildfly-maven-plugin</artifactId>
				    <version>1.1.0.Final</version>
				</plugin>
			</plugins>
		</pluginManagement>
	
		<plugins>
			<plugin>
				<groupId>external.atlassian.jgitflow</groupId>
				<artifactId>jgitflow-maven-plugin</artifactId>
				<version>1.0-m5.1</version>
				<configuration>
					<flowInitContext>
						<masterBranchName>master</masterBranchName>
						<developBranchName>development</developBranchName>
						<featureBranchPrefix>feature-</featureBranchPrefix>
						<releaseBranchPrefix>release-</releaseBranchPrefix>
						<hotfixBranchPrefix>hotfix-</hotfixBranchPrefix>
					</flowInitContext>
					<username>${jgitflow.username}</username>
					<password>${jgitflow.password}</password>
				</configuration>
			</plugin>

			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-deploy-plugin</artifactId>
				<version>2.8</version>
				<configuration>
					<deployAtEnd>true</deployAtEnd>
				</configuration>
			</plugin>
		</plugins>
	</build>

	<scm>
		<connection>scm:git:https://github.com/UnionVMS/USM.git</connection>
		<url>https://github.com/UnionVMS/USM</url>
		<tag>HEAD</tag>
	</scm>
	
	<profiles>
		   
        <profile>
            <id>docker-start</id>
            <properties>
                <docker.dev.start.phase>validate</docker.dev.start.phase>
                <docker.dev.stop.phase>clean</docker.dev.stop.phase>
            </properties>
        </profile>
        <profile>
            <id>docker-stop</id>
            <properties>
                <docker.dev.start.phase>none</docker.dev.start.phase>
                <docker.dev.stop.phase>clean</docker.dev.stop.phase>
            </properties>
        </profile>
        <profile>
            <id>docker</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>io.fabric8</groupId>
                        <artifactId>docker-maven-plugin</artifactId>
                        <version>0.21.0</version>
                        <executions>
            <execution>
                  <id>verifyallstopped</id>
                  <phase>${docker.dev.stop.phase}</phase>
                  <goals>
                    <goal>stop</goal>
                    <goal>remove</goal>
                  </goals>
                  <configuration>
                    <removeAll>false</removeAll>
                    <allContainers>true</allContainers>
                    <removeVolumes>true</removeVolumes>
                    <useColor>true</useColor>
                  </configuration>
                </execution>
                            <execution>
                                <id>start</id>
                                <phase>${docker.dev.start.phase}</phase>
                                <goals>
                                    <goal>start</goal>
                                </goals>
                            </execution>
                            <execution>
                                <id>stop</id>
                                <phase>${docker.dev.stop.phase}</phase>
                                <goals>
                                    <goal>stop</goal>
                                </goals>
                                <configuration>
                                    <allContainers>true</allContainers>
                                </configuration>
                            </execution>
                        </executions>
                        <configuration>
                        <verbose>true</verbose>
                            <images>
                              <image>
                                    <alias>postgres</alias>
                                    <name>uvms/postgres-base:${docker.dev.version}</name>
                                    <run>
                                        <net>bridge</net>
                                        <namingStrategy>none</namingStrategy>
                                        <ports>
                                            <port>5432:5432</port>
                                        </ports>
                                        <wait>
                                            <log>(?s)ready for start up.*database system is ready to accept connections</log>
                                            <time>60000</time>
                                            <kill>2000</kill>
                                            <shutdown>1000</shutdown>
                                        </wait>
                                        <dependsOn>
                                            <container>activemq</container>
                                        </dependsOn>
                                        <links>
                                            <link>activemq:activemq</link>
                                        </links>
                                        <log>
                                            <enabled>true</enabled>
                                            <color>green</color>
                                        </log>
                                        <hostname>postgres</hostname>
                                    </run>
                                </image>
                            
                                <image>
                                    <alias>activemq</alias>
                                    <name>uvms/activemq:${docker.dev.version}</name>
                                    <run>
                                        <net>bridge</net>
                                        <namingStrategy>none</namingStrategy>
                                        <ports>
                                            <port>8161:8161</port>
                                        </ports>
                                        <wait>
                                            <tcp>
                                                <host>${docker.machine.ip}</host>
                                                <ports>
                                                    <port>8161</port>
                                                </ports>
                                            </tcp>
                                            <kill>5000</kill>
                                            <shutdown>5000</shutdown>
                                            <time>15000</time>
                                        </wait>
                                        <log>
                                            <enabled>true</enabled>
                                            <color>red</color>
                                        </log>
                                        <hostname>activemq</hostname>
                                    </run>
                                </image>
                                <!-- 
                                 -->
                                <image>
                                    <alias>wildfly</alias>
                                    <name>uvms/wildfly-base:${docker.dev.version}</name>
                                    <run>
                                        <net>bridge</net>
                                        <namingStrategy>none</namingStrategy>
                                        <links>
                                            <link>postgres:postgres</link>
                                            <link>activemq:activemq</link>
                                        </links>
                                        <ports>
                                            <port>9990:9990</port>
                                            <port>8787:8787</port>
                                            <port>8080:8080</port>
                                            <port>8443:8443</port>                                            
                                        </ports>
                                        <wait>
                                            <log>WildFly 8.2.1.Final "Tweek" started in</log>
                                            <time>300000</time>
                                            <kill>2000</kill>
                                            <shutdown>1000</shutdown>
                                        </wait>
                                        <dependsOn>
                                            <container>postgres</container>
                                            <container>activemq</container>
                                        </dependsOn>
                                        <log>
                                            <enabled>true</enabled>
                                            <color>blue</color>
                                        </log>
                                        <hostname>wildfly</hostname>
                                    </run>
                                </image>
                            </images>
                        </configuration>
                    </plugin>
            </plugins>
                    </build>
                    </profile>
                    
	</profiles>	
</project>